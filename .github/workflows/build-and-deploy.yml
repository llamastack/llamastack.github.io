name: Build and Deploy Docusaurus Documentation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (latest, v0.2.23, etc.)'
        required: false
        default: 'latest'
        type: string
      action:
        description: 'Action to perform'
        required: false
        default: 'build-and-deploy'
        type: choice
        options:
          - build-only
          - deploy-only
          - build-and-deploy

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    if: ${{ github.event.inputs.action != 'deploy-only' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Clone llama-stack repository
      run: |
        echo "üì• Cloning llama-stack repository..."
        TEMP_DIR=$(mktemp -d)
        echo "TEMP_DIR=$TEMP_DIR" >> $GITHUB_ENV

        git clone https://github.com/llamastack/llama-stack.git "$TEMP_DIR/llama-stack"
        cd "$TEMP_DIR/llama-stack"
        git fetch --all --tags

        # Determine version to checkout
        VERSION="${{ github.event.inputs.version }}"
        if [ "$VERSION" = "latest" ] || [ -z "$VERSION" ]; then
          git checkout main
          echo "‚úÖ Using main branch (latest)"
          echo "BUILDING_LATEST=true" >> $GITHUB_ENV
          echo "VERSION_TAG=latest" >> $GITHUB_ENV
        else
          git checkout "$VERSION"
          echo "‚úÖ Using tag: $VERSION"
          echo "BUILDING_LATEST=false" >> $GITHUB_ENV
          echo "VERSION_TAG=$VERSION" >> $GITHUB_ENV
        fi

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup caching for build artifacts
      uses: actions/cache@v4
      id: cache-npm
      with:
        path: ~/.npm
        key: npm-${{ runner.os }}-${{ hashFiles('${{ env.TEMP_DIR }}/llama-stack/docs/package-lock.json') }}
        restore-keys: |
          npm-${{ runner.os }}-

    - name: Install dependencies and setup versioning
      run: |
        echo "üì¶ Installing dependencies..."
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"
        npm ci
        echo "‚úÖ Dependencies installed"

        echo "‚öôÔ∏è Setting up versioning configuration..."

        # Copy persistent versionsArchived.json from repo
        cp "${{ github.workspace }}/versionsArchived.json" ./

        # Load existing versions.json from deployed site or create empty
        if [ -f "${{ github.workspace }}/docs/versions.json" ]; then
          # If we're building a specific version, exclude it from the imported versions.json
          if [ "${{ env.BUILDING_LATEST }}" != "true" ]; then
            # Filter out the version we're about to build
            node -e "
            const versions = JSON.parse(require('fs').readFileSync('${{ github.workspace }}/docs/versions.json', 'utf8'));
            const filtered = versions.filter(v => v !== '${{ env.VERSION_TAG }}');
            require('fs').writeFileSync('versions.json', JSON.stringify(filtered, null, 2));
            console.log('‚úÖ Loaded versions.json (filtered out ${{ env.VERSION_TAG }})');
            "
          else
            cp "${{ github.workspace }}/docs/versions.json" ./
            echo "‚úÖ Loaded existing versions.json"
          fi
        else
          echo "[]" > versions.json
          echo "‚úÖ Created empty versions.json"
        fi

        # Patch Docusaurus config for versioning
        node << 'EOF'
        const fs = require('fs');

        let config = fs.readFileSync('docusaurus.config.ts', 'utf8');

        // Add versioning imports after OpenAPI import
        const versioningImports = `
        // Import fs for versioning configuration
        const fs = require('fs');

        // Versioning configuration for llamastack.github.io
        const versionsArchived = (() => {
          try {
            return JSON.parse(fs.readFileSync('./versionsArchived.json', 'utf8'));
          } catch (e) {
            console.warn('Could not load versionsArchived.json:', e);
            return {};
          }
        })();

        const archivedVersionsDropdownItems = Object.entries(versionsArchived).map(
          ([versionName, versionUrl]) => ({
            label: versionName,
            href: versionUrl,
          })
        );
        `;

        config = config.replace(
          /import type \* as OpenApiPlugin from "docusaurus-plugin-openapi-docs";/,
          `import type * as OpenApiPlugin from "docusaurus-plugin-openapi-docs";

        ${versioningImports}`
        );

        // Add version dropdown to navbar (replace GitHub item)
        const versionDropdown = `        {
          href: 'https://github.com/llamastack/llama-stack',
          label: 'GitHub',
          position: 'right',
        },
        {
          type: 'docsVersionDropdown',
          position: 'right',
          dropdownItemsAfter: archivedVersionsDropdownItems.length > 0 ? [
            {
              type: 'html',
              value: '<hr class="dropdown-separator">',
            },
            {
              type: 'html',
              className: 'dropdown-archived-versions',
              value: '<b>Previous versions</b>',
            },
            ...archivedVersionsDropdownItems,
          ] : [],
        },`;

        config = config.replace(
          /\s*{\s*href:\s*'https:\/\/github\.com\/llamastack\/llama-stack',\s*label:\s*'GitHub',\s*position:\s*'right',\s*},/,
          versionDropdown
        );

        fs.writeFileSync('docusaurus.config.ts', config);
        console.log('‚úÖ Configuration patched');
        EOF

        echo "‚úÖ Configuration patches applied"

    - name: Import existing versioning artifacts
      run: |
        echo "üì• Importing existing versioning artifacts from repository..."
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"

        # Copy existing versioned_docs if they exist
        if [ -d "${{ github.workspace }}/versioned_docs" ]; then
          cp -r "${{ github.workspace }}/versioned_docs" ./
          echo "‚úÖ Imported existing versioned_docs"
        else
          echo "‚ÑπÔ∏è No existing versioned_docs found (first version)"
        fi

        # Copy existing versioned_sidebars if they exist
        if [ -d "${{ github.workspace }}/versioned_sidebars" ]; then
          cp -r "${{ github.workspace }}/versioned_sidebars" ./
          echo "‚úÖ Imported existing versioned_sidebars"
        else
          echo "‚ÑπÔ∏è No existing versioned_sidebars found (first version)"
        fi

        # Copy existing versions.json if it exists (overrides what we loaded earlier)
        if [ -f "${{ github.workspace }}/versions.json" ]; then
          cp "${{ github.workspace }}/versions.json" ./
          echo "‚úÖ Imported existing versions.json"
        else
          echo "‚ÑπÔ∏è No existing versions.json found (first version)"
        fi

        echo "‚úÖ Versioning artifacts import completed"

    - name: Check for content changes (optimization)
      id: content-changes
      run: |
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"

        # Create hash of all documentation content
        CONTENT_HASH=$(find docs static -type f \( -name "*.md" -o -name "*.mdx" -o -name "*.yaml" -o -name "*.json" \) -exec md5sum {} \; | sort | md5sum | cut -d' ' -f1)
        echo "CONTENT_HASH=$CONTENT_HASH" >> $GITHUB_OUTPUT
        echo "üìä Content hash: $CONTENT_HASH"

        # For latest builds, check if content has changed since last deployment
        if [ "${{ env.BUILDING_LATEST }}" = "true" ]; then
          # Try to get the last deployment hash from the deployed site
          LAST_HASH=""
          if curl -s "https://llamastack.github.io/content-hash.txt" > /tmp/last_hash.txt 2>/dev/null; then
            LAST_HASH=$(cat /tmp/last_hash.txt)
            echo "üìä Previous hash: $LAST_HASH"
          fi

          if [ "$CONTENT_HASH" = "$LAST_HASH" ] && [ -n "$LAST_HASH" ]; then
            echo "‚úÖ Content unchanged since last deployment"
            echo "CONTENT_CHANGED=false" >> $GITHUB_OUTPUT
          else
            echo "üîÑ Content has changed since last deployment"
            echo "CONTENT_CHANGED=true" >> $GITHUB_OUTPUT
          fi
        else
          # For version builds, always process (new version)
          echo "üîÑ Building version ${{ env.VERSION_TAG }}"
          echo "CONTENT_CHANGED=true" >> $GITHUB_OUTPUT
        fi

    - name: Cache stable API docs
      uses: actions/cache@v4
      id: cache-api-stable
      with:
        path: ${{ env.TEMP_DIR }}/llama-stack/docs/docs/api
        key: api-stable-${{ env.VERSION_TAG }}-${{ hashFiles('${{ env.TEMP_DIR }}/llama-stack/docs/static/llama-stack-spec.yaml') }}
        restore-keys: |
          api-stable-${{ env.VERSION_TAG }}-
          api-stable-

    - name: Cache experimental API docs
      uses: actions/cache@v4
      id: cache-api-experimental
      with:
        path: ${{ env.TEMP_DIR }}/llama-stack/docs/docs/api-experimental
        key: api-experimental-${{ env.VERSION_TAG }}-${{ hashFiles('${{ env.TEMP_DIR }}/llama-stack/docs/static/experimental-llama-stack-spec.yaml') }}
        restore-keys: |
          api-experimental-${{ env.VERSION_TAG }}-
          api-experimental-

    - name: Cache deprecated API docs
      uses: actions/cache@v4
      id: cache-api-deprecated
      with:
        path: ${{ env.TEMP_DIR }}/llama-stack/docs/docs/api-deprecated
        key: api-deprecated-${{ env.VERSION_TAG }}-${{ hashFiles('${{ env.TEMP_DIR }}/llama-stack/docs/static/deprecated-llama-stack-spec.yaml') }}
        restore-keys: |
          api-deprecated-${{ env.VERSION_TAG }}-
          api-deprecated-

    - name: Cache Docusaurus build artifacts
      uses: actions/cache@v4
      id: cache-docusaurus-build
      with:
        path: |
          ${{ env.TEMP_DIR }}/llama-stack/docs/.docusaurus
          ${{ env.TEMP_DIR }}/llama-stack/docs/build
        key: docusaurus-build-${{ env.VERSION_TAG }}-${{ hashFiles('${{ env.TEMP_DIR }}/llama-stack/docs/docs/**/*.{md,mdx}', '${{ env.TEMP_DIR }}/llama-stack/docs/static/**/*', '${{ env.TEMP_DIR }}/llama-stack/docs/docusaurus.config.ts', '${{ env.TEMP_DIR }}/llama-stack/docs/package.json') }}
        restore-keys: |
          docusaurus-build-${{ env.VERSION_TAG }}-
          docusaurus-build-

    - name: Build documentation
      # Skip if content hasn't changed (latest builds only)
      if: ${{ steps.content-changes.outputs.CONTENT_CHANGED == 'true' }}
      run: |
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"

        # Generate API docs selectively based on cache status
        echo "üîÑ Generating API docs..."

        # Generate stable API docs if not cached
        if [ "${{ steps.cache-api-stable.outputs.cache-hit }}" != 'true' ]; then
          echo "  üìÑ Generating stable API docs (cache miss)..."
          npm run gen-api-docs stable
        else
          echo "  ‚ö° Using cached stable API docs"
        fi

        # Generate experimental API docs if not cached
        if [ "${{ steps.cache-api-experimental.outputs.cache-hit }}" != 'true' ]; then
          echo "  üìÑ Generating experimental API docs (cache miss)..."
          npm run gen-api-docs experimental
        else
          echo "  ‚ö° Using cached experimental API docs"
        fi

        # Generate deprecated API docs if not cached
        if [ "${{ steps.cache-api-deprecated.outputs.cache-hit }}" != 'true' ]; then
          echo "  üìÑ Generating deprecated API docs (cache miss)..."
          npm run gen-api-docs deprecated
        else
          echo "  ‚ö° Using cached deprecated API docs"
        fi

        echo "‚úÖ API docs generation completed"

        # Create version if not latest (after content is ready)
        if [ "${{ env.BUILDING_LATEST }}" != "true" ]; then
          echo "üìö Creating Docusaurus version: ${{ env.VERSION_TAG }}"

          # Create the version snapshot
          npx docusaurus docs:version "${{ env.VERSION_TAG }}"

          # Ensure prompt-format.png is available where versioned docs expect it
          mkdir -p versioned_docs/resources
          if [ ! -f "versioned_docs/resources/prompt-format.png" ]; then
            echo "üì• Downloading missing prompt-format.png..."
            curl -o versioned_docs/resources/prompt-format.png https://raw.githubusercontent.com/llamastack/llama-stack/main/docs/static/img/prompt-format.png
            echo "‚úÖ Downloaded prompt-format.png to versioned_docs/resources/"
          else
            echo "‚úÖ prompt-format.png already exists in versioned_docs/resources/"
          fi

          echo "‚úÖ Version ${{ env.VERSION_TAG }} created"
        else
          echo "üèóÔ∏è Building latest version (no version snapshot needed)"
        fi

    - name: Fix versioned docs relative imports
      run: |
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"

        echo "üîß Fixing relative imports in versioned docs..."

        # Universal fix: Replace any raw-loader relative imports that go up to repo root
        # This handles any depth by using regex pattern matching
        if [ -d "versioned_docs" ]; then
          find versioned_docs -name "*.mdx" -type f \
            -exec grep -l "!!raw-loader!\.\." {} \; | \
            while read file; do
              echo "Fixing raw-loader imports in $file"
              # Use perl for more sophisticated regex replacement
              # Pattern: !!raw-loader! followed by any number of ../ then a filename
              # Replace with absolute path to repo root + filename
              perl -i -pe "s|!!raw-loader!(\.\.\/)+([^'\"]*)|!!raw-loader!${{ env.TEMP_DIR }}/llama-stack/\$2|g" "$file"
            done
          echo "‚úÖ Versioned docs import paths corrected"
        else
          echo "‚ÑπÔ∏è No versioned docs found"
        fi

    - name: Build Docusaurus site
      # Skip if content hasn't changed (latest builds only)
      if: ${{ steps.content-changes.outputs.CONTENT_CHANGED == 'true' }}
      run: |
        cd "${{ env.TEMP_DIR }}/llama-stack/docs"

        # Check if we can skip build due to cache hit
        if [ "${{ steps.cache-docusaurus-build.outputs.cache-hit }}" = 'true' ]; then
          echo "‚ö° Using cached Docusaurus build (cache hit)"

          # Verify build output exists and is valid
          if [ -f "build/index.html" ] && [ -d "build/assets" ]; then
            echo "‚úÖ Cached build is valid, skipping build step"
          else
            echo "‚ö†Ô∏è Cache hit but build output missing/invalid, rebuilding..."
            FORCE_BUILD=true
          fi
        else
          echo "üîÑ Building Docusaurus site (cache miss)..."
          FORCE_BUILD=true
        fi

        if [ "${FORCE_BUILD:-false}" = 'true' ]; then
          # Patch out duplicate version badges from OpenAPI MDX files
          echo "üîß Patching out duplicate version badges..."
          find . -name "llama-stack-specification.info.mdx" -type f -exec sed -i '/<span$/,/<\/span>$/d' {} \;

          # Also patch versioned files if they exist
          if [ -d "versioned_docs" ]; then
            find versioned_docs -name "llama-stack-specification.info.mdx" -type f -exec sed -i '/<span$/,/<\/span>$/d' {} \;
          fi
          echo "‚úÖ Version badge patching completed"

          # Build the site
          npm run build
          echo "‚úÖ Docusaurus build completed"
        fi

    - name: Deploy to GitHub Pages
      run: |
        if [ "${{ steps.content-changes.outputs.CONTENT_CHANGED }}" = 'false' ]; then
          echo "‚ö° Deploying cached build (no content changes detected)"
        else
          echo "üóÇÔ∏è Deploying fresh Docusaurus build..."
        fi

        DOCS_DIR="${{ github.workspace }}/docs"

        # Handle deployment based on whether content changed
        if [ "${{ steps.content-changes.outputs.CONTENT_CHANGED }}" = 'true' ]; then
          # Fresh build - deploy new content
          # Smart deployment: clear everything except .git, .nojekyll, and archived versions
          find "$DOCS_DIR" -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.nojekyll' ! -name 'v[0-9]*' -exec rm -rf {} +

          # Copy Docusaurus build output
          cp -r "${{ env.TEMP_DIR }}/llama-stack/docs/build/"* "$DOCS_DIR/"
        else
          # No content changes - keep existing deployment, just update metadata
          echo "üìÇ Keeping existing deployment (content unchanged)"
        fi

        # Ensure .nojekyll exists
        touch "$DOCS_DIR/.nojekyll"

        # Save content hash for future optimization checks
        if [ -n "${{ steps.content-changes.outputs.CONTENT_HASH }}" ]; then
          echo "${{ steps.content-changes.outputs.CONTENT_HASH }}" > "$DOCS_DIR/content-hash.txt"
          echo "üíæ Saved content hash for future builds"
        fi

        echo "‚úÖ Docusaurus content deployed"

    - name: Update workspace artifacts
      if: env.BUILDING_LATEST != 'true'
      run: |
        echo "üìã Updating workspace versioning artifacts..."

        BUILD_PATH="${{ env.TEMP_DIR }}/llama-stack/docs"

        # Copy versioned docs and sidebars to workspace (for git commit)
        if [ -d "$BUILD_PATH/versioned_docs" ]; then
          cp -r "$BUILD_PATH/versioned_docs" "${{ github.workspace }}/"
          echo "‚úÖ Copied versioned_docs to workspace"
        fi

        if [ -d "$BUILD_PATH/versioned_sidebars" ]; then
          cp -r "$BUILD_PATH/versioned_sidebars" "${{ github.workspace }}/"
          echo "‚úÖ Copied versioned_sidebars to workspace"
        fi

        # Copy updated versions.json to workspace
        cp "$BUILD_PATH/versions.json" "${{ github.workspace }}/"
        echo "‚úÖ Updated workspace versions.json"

    - name: Setup versioning files in deployed site
      run: |
        echo "‚öôÔ∏è Setting up versioning configuration files..."

        BUILD_PATH="${{ env.TEMP_DIR }}/llama-stack/docs"

        # Copy versioning files to deployment
        cp "$BUILD_PATH/versionsArchived.json" "${{ github.workspace }}/docs/"
        cp "$BUILD_PATH/versions.json" "${{ github.workspace }}/docs/"

        echo "‚úÖ Versioning files created"

    - name: Verify deployment structure
      run: |
        echo "üîç Verifying deployment structure..."

        echo "Contents of docs directory:"
        ls -la "${{ github.workspace }}/docs/" | head -10

        echo -e "\nVersioning files:"
        [ -f "${{ github.workspace }}/docs/versionsArchived.json" ] && echo "‚úÖ versionsArchived.json exists" || echo "‚ùå versionsArchived.json missing"
        [ -f "${{ github.workspace }}/docs/versions.json" ] && echo "‚úÖ versions.json exists" || echo "‚ùå versions.json missing"

        echo -e "\n‚úÖ Structure verification complete"

    - name: Commit versioning artifacts
      if: env.BUILDING_LATEST != 'true'
      run: |
        echo "üíæ Committing versioning artifacts..."

        cd "${{ github.workspace }}"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add versioning artifacts
        git add versioned_docs/ versioned_sidebars/ versions.json 2>/dev/null || true

        # Commit if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "Add Docusaurus version ${{ env.VERSION_TAG }}

          - Created version snapshot in versioned_docs/version-${{ env.VERSION_TAG }}/
          - Updated versions.json with new version
          - Built and deployed multi-version site

          ü§ñ Generated by Docusaurus versioning workflow"

          git push
          echo "‚úÖ Changes committed and pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi

    - name: Setup GitHub Pages
      if: ${{ github.event.inputs.action == 'build-and-deploy' }}
      uses: actions/configure-pages@v5

    - name: Upload Pages artifact
      if: ${{ github.event.inputs.action == 'build-and-deploy' }}
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'docs'

  deploy:
    if: ${{ github.event.inputs.action == 'build-and-deploy' }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  deploy-only:
    if: ${{ github.event.inputs.action == 'deploy-only' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup GitHub Pages
      uses: actions/configure-pages@v5

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'docs'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
